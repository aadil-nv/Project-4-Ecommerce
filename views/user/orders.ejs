<%- include('../partials/mainheader.ejs')%>
    <style>
        #orderid {
            color: black;
            font-weight: 600;
            align-items: start;
            display: block;
            padding-left: 50px;
            padding-top: 30px;
        }

        #table-main {
            padding-bottom: 300px;
        }

        #button-user1 {
            background-color: rgb(37, 0, 122);
           
            color: white;
            width: 120px;
            height: 35px;
            border: none;
            border-radius: 30px;
        }
        #button-user {
            background-color: red;
            color: white;
            width: 90px;
            height: 35px;
            border: none;
            border-radius: 30px;
        }

        #table {
            border-radius: 30px;
        }
        #save {
            background-color: rgb(10, 129, 40);
            border: none;
            height: 53px;
            color: white;
        }
    </style>

    <div class="breadcrumb-area bg-gray-4 breadcrumb-padding-1" style="background-color: rgb(198, 198, 228)">
        <% orderData.forEach((item)=> { %>
        <h3 id="orderid">Thankyou for your Purchase <%= item.userId.name %></h3>
            <% }) %>
        <div class="banner-area pb-70 pt-80">
            <div class="container" style="height: 600px">
                <div class="row">
                    <div class="col-lg-12 col-md-6 col-12">
                        <div class="col-lg-6 col-md-6 mb-lg-0 mb-15">
                            <span>
                                <i class="material-icons md-calendar_today"></i>
                                <b>Wed, Aug 13, 2020, 4:34PM</b>
                            </span>
                            <br />
                            <small class="text-muted">Order ID: 3453012</small>
                        </div>

                        <table class="table table-bordered">
                            <thead class="thead-light" id="table">
                                <tr>
                                    <th>Product Image</th>
                                    <th>Product Name</th>
                                    <th>Quantity</th>
                                    <th>Total Price</th>

                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            
                           
                            <% if(orderData.length> 0){ %>
                                <% orderData.forEach((item)=> { %>
                                    
                                        <input type="hidden" value="<%= item._id%>" id="orderId" name="orderId">
                                        
                                        <%item.orderedItem.forEach((product)=> { %>

                                        <tbody>
                                            <tr>
                                                <td>
                                                    <img src="/uploads/<%=product.productId.productimage[0] %>"
                                                        width="100px" class="rounded-3" />
                                                </td>
                                                <td id="pooo">
                                                    <%=product.productId.productname %>

                                                </td>
                                                <td>
                                                    <%=product.quantity %>
                                                </td>
                                                <td>
                                                    <%=product.totalProductAmount %>
                                                </td>

                                                <td>
                                                    <%=product.productStatus %>
                                                </td>
                                                <% if(product.productStatus==="Order Cancelled") {%>
                                               
                                                    <td>
                                                        <p>Order canceld you ? Need Help</p>
                                                       
                                                    </td>
                                                    <%}else if(product.productStatus==="Delivered"){%>
                                                        <td>
                                                       
                                                       <!-- <button
                                                              id="button-user1" class="check-btn sqr-btn"
                                                        data-bs-toggle="modal" id="sendId" data-whatever="@mdo"
                                                        data-bs-target="#exampleModal"> Retrun Product </button>
                                                        
                                                        </td> -->
                                                        <button id="button-user1"    onclick="requestReturn('<%= product.productId._id %>','<%= item._id %>','<%= item.paymentMethod %>','<%=  product.quantity %>','<%=  product.totalProductAmount %>'  )">return Product</button>
                                                       
                                                        <%}else{%>
                                                       <td>
                                                        <button id="button-user"
                                                            data-product-id="<%= product.productId._id %>"
                                                            onclick="cancelOrder(this)"  >
                                                            Cancel
                                                        </button>
                                                    </td>
                                                    <%}%>
                                            </tr>
                                        </tbody>
                                        <% }); %>
                                            <% }); %>
                                                <% }%>
                        </table>
                        <div class="row">
                            <div class="col-6">
                                <table class="table table-bordered">
                                    <thead class="thead-light" id="table">
                                        <tr>
                                            <th>Delivery Address</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <% orderData.forEach((item)=> { %>
                                            <tr>
                                                <td>
                                                    Name :<%= item.deliveryAddress.name %> <br />
                                                        Mobile :<%= item.deliveryAddress.mobile %><br />
                                                            Pincode:<%= item.deliveryAddress.pincode %><br />
                                                                Address :<%= item.deliveryAddress.address %><br />
                                                                    StreetAddress<%= item.deliveryAddress.streetaddress
                                                                        %><br />
                                                                        City :<%= item.deliveryAddress.city %><br />
                                                                            State:<%= item.deliveryAddress.state %>
                                                                                <br />
                                                                                Landmark :<%=
                                                                                    item.deliveryAddress.landmark %>
                                                </td>
                                            </tr>
                                            <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-6">
                                <table class="table table-bordered">
                                    <thead class="thead-light" id="table">
                                        <tr>
                                            <th>Payment Detiles</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <% orderData.forEach((item)=> { %>
                                            <tr>
                                                <td>
                                                    <%= item.paymentMethod %>
                                                </td>
                                            </tr>
                                            <% }); %>
                                    </tbody>
                                </table>
                                <table class="table table-bordered">
                                    <thead class="thead-light" id="table">
                                        <tr>
                                            <th>Total Paid</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <% orderData.forEach((item)=> { %>
                                            <tr>
                                                <td>
                                                    <%= item.orderAmount %>
                                                </td>
                                            </tr>
                                            <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="related-product-area pb-95 pt-100">
        <div class="container">
            <div class="section-title-2 st-border-center text-center mb-75" data-aos="fade-up" data-aos-delay="200">
                <h2>Related Products</h2>
            </div>
            <div class="related-product-active swiper-container">
                <div class="swiper-wrapper">
                    <div class="swiper-slide">
                        <div class="product-wrap" data-aos="fade-up" data-aos-delay="200">
                            <div class="product-img img-zoom mb-25">
                                <a href="product-details.html">
                                    <img src="/userpublic/indexassets/assets/images/product/product-1.png" alt="" />
                                </a>
                                <div class="product-badge badge-top badge-right badge-pink">
                                    <span>-10%</span>
                                </div>
                                <div class="product-action-wrap">
                                    <button class="product-action-btn-1" title="Wishlist">
                                        <i class="pe-7s-like"></i>
                                    </button>
                                    <button class="product-action-btn-1" title="Quick View" data-bs-toggle="modal"
                                        data-bs-target="#exampleModal">
                                        <i class="pe-7s-look"></i>
                                    </button>
                                </div>
                                <div class="product-action-2-wrap">
                                    <button class="product-action-btn-2" title="Add To Cart">
                                        <i class="pe-7s-cart"></i> Add to cart
                                    </button>
                                </div>
                            </div>
                            <div class="product-content">
                                <h3><a href="product-details.html">New Modern Sofa Set</a></h3>
                                <div class="product-price">
                                    <span class="old-price">$25.89 </span>
                                    <span class="new-price">$20.25 </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="product-wrap" data-aos="fade-up" data-aos-delay="400">
                            <div class="product-img img-zoom mb-25">
                                <a href="product-details.html">
                                    <img src="/userpublic/indexassets/assets/images/product/product-2.png" alt="" />
                                </a>
                                <div class="product-action-wrap">
                                    <button class="product-action-btn-1" title="Wishlist">
                                        <i class="pe-7s-like"></i>
                                    </button>
                                    <button class="product-action-btn-1" title="Quick View" data-bs-toggle="modal"
                                        data-bs-target="#exampleModal">
                                        <i class="pe-7s-look"></i>
                                    </button>
                                </div>
                                <div class="product-action-2-wrap">
                                    <button class="product-action-btn-2" title="Add To Cart">
                                        <i class="pe-7s-cart"></i> Add to cart
                                    </button>
                                </div>
                            </div>
                            <div class="product-content">
                                <h3><a href="product-details.html">New Modern Sofa Set</a></h3>
                                <div class="product-price">
                                    <span>$50.25 </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="product-wrap" data-aos="fade-up" data-aos-delay="600">
                            <div class="product-img img-zoom mb-25">
                                <a href="product-details.html">
                                    <img src="/userpublic/indexassets/assets/images/product/product-3.png" alt="" />
                                </a>
                                <div class="product-badge badge-top badge-right badge-pink">
                                    <span>-10%</span>
                                </div>
                                <div class="product-action-wrap">
                                    <button class="product-action-btn-1" title="Wishlist">
                                        <i class="pe-7s-like"></i>
                                    </button>
                                    <button class="product-action-btn-1" title="Quick View" data-bs-toggle="modal"
                                        data-bs-target="#exampleModal">
                                        <i class="pe-7s-look"></i>
                                    </button>
                                </div>
                                <div class="product-action-2-wrap">
                                    <button class="product-action-btn-2" title="Add To Cart">
                                        <i class="pe-7s-cart"></i> Add to cart
                                    </button>
                                </div>
                            </div>
                            <div class="product-content">
                                <h3><a href="product-details.html">Easy Modern Chair</a></h3>
                                <div class="product-price">
                                    <span class="old-price">$45.00 </span>
                                    <span class="new-price">$40.00 </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="product-wrap" data-aos="fade-up" data-aos-delay="800">
                            <div class="product-img img-zoom mb-25">
                                <a href="product-details.html">
                                    <img src="/userpublic/indexassets/assets/images/product/product-4.png" alt="" />
                                </a>
                                <div class="product-action-wrap">
                                    <button class="product-action-btn-1" title="Wishlist">
                                        <i class="pe-7s-like"></i>
                                    </button>
                                    <button class="product-action-btn-1" title="Quick View" data-bs-toggle="modal"
                                        data-bs-target="#exampleModal">
                                        <i class="pe-7s-look"></i>
                                    </button>
                                </div>
                                <div class="product-action-2-wrap">
                                    <button class="product-action-btn-2" title="Add To Cart">
                                        <a href="#" onclick=""><i class="pe-7s-cart"></i>Add To Cart</a>
                                    </button>
                                </div>
                            </div>
                            <div class="product-content">
                                <h3><a href="product-details.html">Stylish Swing Chair</a></h3>
                                <div class="product-price">
                                    <span>$30.25 </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="product-wrap">
                            <div class="product-img img-zoom mb-25">
                                <a href="product-details.html">
                                    <img src="/userpublic/indexassets/assets/images/product/product-2.png" alt="" />
                                </a>
                                <div class="product-badge badge-top badge-right badge-pink">
                                    <span>-10%</span>
                                </div>
                                <div class="product-action-wrap">
                                    <button class="product-action-btn-1" title="Wishlist">
                                        <i class="pe-7s-like"></i>
                                    </button>
                                    <button class="product-action-btn-1" title="Quick View" data-bs-toggle="modal"
                                        data-bs-target="#exampleModal">
                                        <i class="pe-7s-look"></i>
                                    </button>
                                </div>
                                <div class="product-action-2-wrap">
                                    <button class="product-action-btn-2" title="Add To Cart">
                                        <i class="pe-7s-cart"></i> Add to cart
                                    </button>
                                </div>
                            </div>
                            <div class="product-content">
                                <h3><a href="product-details.html">New Modern Sofa Set</a></h3>
                                <div class="product-price">
                                    <span class="old-price">$80.50 </span>
                                    <span class="new-price">$75.25 </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

  


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <script>  
        async function cancelOrder(button) {
            const productId = button.getAttribute("data-product-id");
            const orderId = document.getElementById('orderId').value
                console.log("--------------orderid is +++   ----------------------------",orderId)
                console.log("--------------productId is--------------------------",productId)
            // Display a SweetAlert confirmation dialog
            Swal.fire({
                title: "Are you sure?",
                text: "This action cannot be undone!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, cancel it!",
                cancelButtonText: "No, keep it",
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/ordersone/${productId}`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ productId: productId ,orderId}),
                        });

                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }

                        // Optionally, perform any additional actions after successful cancellation
                        window.location.reload();
                    } catch (error) {
                        console.error(error);
                        // Optionally, display an error message to the user
                    }
                } else {
                    // Action cancelled by user
                    console.log("Action cancelled");
                }
            });
        }
    </script>





<!-- <script>
 
    function returnProduct(id) {
        
        const orderId = document.getElementById('orderId').value

        
        
        
        
        
        console.log("==============================" , orderId)
        
        event.preventDefault();

        Swal.fire({
            title: 'Are you sure?',
            text: 'Do you want to return this product?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, return it!',
            cancelButtonText: 'No, cancel',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Call fetch method to send the ID of the product to the controller
                // const productId = document.getElementById('productID').value
                fetch('/user/productreturn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ productId: productId }) // Pass the product ID here
                })
                .then(response => {
                    // Handle response from the server
                    if (response.ok) {
                        // Product returned successfully
                        Swal.fire('Returned!', 'Your product has been returned.', 'success');
                    } else {
                        // Product return failed
                        Swal.fire('Error!', 'Failed to return product. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error!', 'An error occurred while returning the product.', 'error');
                });
            } else {
                // User clicked the cancel button or closed the dialog
                Swal.fire('Cancelled', 'Return action cancelled.', 'info');
            }
        });
    }


   

</script> -->
<script>
    function requestReturn(productId, order_id,paymentMethod,quantity,totalProductAmount){
        console.log("=========productId========",productId)
        console.log("==========order_id=======",order_id)
  swal.fire({
    title: 'Reason for return',
    input: 'text',
    inputAttributes: {
      autocapitalize: 'off'
    },
    showCancelButton: true,
    confirmButtonText: 'Submit',
    preConfirm: inputValue => {
      if (inputValue === false) {
        swal.showValidationMessage("Please give reason!");
        return false;
      }
      if (inputValue.trim() === "") {
        swal.showValidationMessage("Please give reason!");
        return false;
      }
      return inputValue;
    },
    customContainerClass: {
      padding: '2rem',
      'font-size': '16px',
      'max-width': '1000px'
    }
  }).then(result => {
    if (result.dismiss === "cancel") {
      swal.fire("Cancelled", "Return request cancelled");
    } else if (result.value) {
      let reason = result.value
      swal.fire({
        title: "Return requested",
        text: "Reason:" + result.value,
        preConfirm:function(){
          fetch('/user/productreturn',{
          method: 'POST',
          body: JSON.stringify({productId, order_id,paymentMethod,quantity,totalProductAmount, reason  }),
          headers:{
            'Content-Type':'application/json'
          }
        })
        .then(response => response.json())
        .then(data=>{
          var statusChange = document.getElementById('status');
          statusChange.innerHTML = data.status;
          document.querySelector('.returnBtn').remove();
        })
        },
        customClass: {
          confirmButton: 'btn btn-primary'
        }
      });
    }
  });
}
</script>

 

    <%- include('../partials/mainfooter.ejs')%>