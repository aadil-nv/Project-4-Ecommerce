<%- include('../partials/asidenav.ejs')%>

    <style>
        #totalsalesamount {
            font-size: 10px;
        }

        #totalsalesamount2 {
            font-size: 20px;
        }

        #monthlyEarning {
            font-size: 15px;
        }

        #card1 {
            height: 150px;
        }

        #card2 {
            height: 150px;
        }

        #card3 {
            height: 150px;
        }

        #card4 {
            height: 150px;
        }

        #card5 {
            height: 150px;
        }

        #card6 {
            height: 150px;
        }

        #card7 {
            height: 150px;
        }

        #card8 {
            height: 150px;
        }

        .chart {
            position: relative;
            width: 400px;
            height: 300px;
            perspective: 1000px;
            perspective-origin: 50% 50%;
        }

        .axis {
            position: absolute;
            background-color: #ccc;
            border: 1px solid #999;
        }

        .x-axis {
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
        }

        .y-axis {
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
        }

        .bar-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            height: 100%;
        }

        .bar {
            width: 50px;
            background-color: steelblue;
            position: relative;
            transform-style: preserve-3d;
        }

        .bar div {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: inherit;
            transition: height 0.5s;
        }

        .bar:hover div {
            height: 100%;
        }

        #buttonmonth {
            margin-top: 20px;
            background-color: #3BB77E;
            color: white;
        }

        #buttonyear {
            margin-top: 20px;
            background-color: #3BB77E;
            color: white;
        }

        #year {
            width: 220px;
            height: 40px;
        }
    </style>
    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title">Dashboard Overview</h2>
                <p>Whole data about your business here</p>
            </div>
            <!-- <div>
                <a href="#" class="btn btn-primary"><i class="text-muted material-icons md-post_add"></i>Create
                    report</a>
            </div> -->
        </div>
        <div class="row">
            <div class="col-lg-3">
                <div class="card card-body mb-4" id="card1">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-primary-light"><i
                                class="text-primary material-icons md-monetization_on"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Revenue</h6>
                            <span id="totalsalesamount2">Rs.<%=totalSalesAmount %>/-</span>
                            <p id="totalsalesamount"> Shipping fees are not included </p>
                        </div>
                    </article>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card card-body mb-4" id="card2">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-success-light"><i
                                class="text-success material-icons md-local_shipping"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Orders</h6>
                            <span>
                                <%= salesCount%>
                            </span>
                            <span class="text-sm"> Excluding orders in transit </span>
                        </div>
                    </article>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card card-body mb-4" id="card3">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-warning-light"><i
                                class="text-warning material-icons md-qr_code"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Products</h6>
                            <span>
                                <%= productCount %>
                            </span>
                            <span class="text-sm"> In <%= categoryCount %> Categories </span>
                        </div>
                    </article>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card card-body mb-4" id="card4">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-info-light"><i
                                class="text-info material-icons md-shopping_basket"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Monthly Sales</h6>
                            <span id="monthlyEarning">Rs.<%= monthlyEarning.toFixed(0) %>/-</span>
                            <span class="text-sm"> Based in your local time. </span>
                        </div>
                    </article>
                </div>
            </div>
        </div>

        <div class="row">
         
            <div class="col-xl-4 col-lg-12">

                <div class="card mb-4" style="height: 200px;">
                    <div>
                        <h5>Best Selling Product</h5>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Products</th>

                            </tr>
                        </thead>
                        <% if(mostBoughtProducts.length> 0) {%>
                            <% let Rank=1 %>
                                <% mostBoughtProducts.forEach(data=>{ %>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <%= Rank++ %>
                                            </td>
                                            <td>
                                                <%= data.productName %>
                                            </td>

                                        </tr>
                                    </tbody>
                                    <% }) %>
                                        <% } %>
                    </table>
                </div>
            </div>

            <div class="col-xl-4 col-lg-12">
                <div class="card mb-4">
                    <div>
                        <h5>Best Selling Categories</h5>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Category LIst</th>

                            </tr>
                        </thead>
                        <% if(mostBoughtCategories.length> 0) {%>
                            <% let Rank=1 %>
                                <% mostBoughtCategories.forEach(data=>{ %>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <%= Rank++ %>
                                            </td>
                                            <td>
                                                <%= data._id %>
                                            </td>

                                        </tr>
                                    </tbody>
                                    <% }) %>
                                        <% } %>
                    </table>
                </div>
            </div>
            <div class="col-xl-4 col-lg-12">
                <div class="card mb-4">
                    <div>
                        <h5>Best Selling Brands</h5>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Brands</th>

                            </tr>
                        </thead>
                        <% if(mostBoughtBrands.length> 0) {%>
                            <% let Rank=1 %>
                                <% mostBoughtBrands.forEach(data=>{ %>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <%= Rank++ %>
                                            </td>
                                            <td>
                                                <%= data._id %>
                                            </td>

                                        </tr>
                                    </tbody>
                                    <% }) %>
                                        <% } %>
                    </table>
                </div>
            </div>


        </div>
        <div class="card mb-4">
            <header class="card-header">
                <h4 class="card-title">Latest orders</h4>
                <div class="row align-items-center">
                    <div class="col-lg-3 col-1 col-md-3">
                        <label for="year">Enter Year</label>
                        <input type="number" class="form-control" id="year" placeholder="YYYY">
                    </div>
                    <div class="col-lg-6 col-12 col-md-3">
                        <button id="buttonmonth" class="btn btn-primary">Monthly</button>
                        <button id="buttonyear" class="btn btn-primary">Yearly</button>
                    </div>
                </div>
                
            </header>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="lineChart"></canvas>
                </div>
              
            </div>
        </div>


    </section>
   
    <footer class="main-footer font-xs">
        <div class="row pb-30 pt-15">
            <div class="col-sm-6">
                <script>
                    document.write(new Date().getFullYear());
                </script>
                &copy; Nest - HTML Ecommerce Template .
            </div>
            <div class="col-sm-6">
                <div class="text-sm-end">All rights reserved</div>
            </div>
        </div>
    </footer>
    </main>

    <script src="./node_modules/chart.js/dist/chart.min.js"></script>
    <script src="/adminpublic/adminlogin/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/adminpublic/adminlogin/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/adminpublic/adminlogin/js/vendors/select2.min.js"></script>
    <script src="/adminpublic/adminlogin/js/vendors/perfect-scrollbar.js"></script>
    <script src="/adminpublic/adminlogin/js/vendors/jquery.fullscreen.min.js"></script>
    <script src="/adminpublic/adminlogin/js/vendors/chart.js"></script>
    <!-- Main Script -->
    <script src="/adminpublic/adminlogin/js/main.js?v=1.1" type="text/javascript"></script>
    <script src="/adminpublic/adminlogin/js/custom-chart.js" type="text/javascript"></script>

    <script>


document.getElementById('buttonmonth').addEventListener('click', function() {
    const year = document.getElementById('year').value;
    sendData(year, 'month');
});

document.getElementById('buttonyear').addEventListener('click', function() {
    const year = document.getElementById('year').value;
    sendData(year, 'year');
});



sendData();

function sendData(year = new Date().getFullYear(), type = 'month') {
    

    fetch('/admin/graphdata', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ year, type })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log("_______________________________")
        console.log(data)
        console.log("_______________________________")
        renderChart(data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}


const canvas = document.getElementById('lineChart');
const ctx = canvas.getContext('2d');
let lineChart = null; // Keep track of the chart instance

function renderChart(data) {
    console.log("******************************");
    console.log(data.labels);
    console.log("******************************");
    const lastMonthData = {
        labels: data.labels,
        datasets: [{
            label: 'Sales',
            data: data.salesData,
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1
        }, {
            label: 'Revenue',
            data: data.revenueData,
            borderColor: 'rgb(255, 99, 132)',
            tension: 0.1
        }]
    };

    // Destroy existing chart instance if it exists
    if (lineChart) {
        lineChart.destroy();
    }

    // Create and render the line chart
    lineChart = new Chart(ctx, {
        type: 'line',
        data: lastMonthData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

    </script>